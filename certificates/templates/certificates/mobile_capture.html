{% extends "certificates/base.html" %}
{% load static %}

{% block title %}üì± CMS - MOBILE CAPTURE {% endblock %}

{% block content %}
<style>
body {
  font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  margin:0;
  background:#f6f7fb;
}
.container {
  max-width:700px;
  margin:20px auto;
  padding:0 12px;
}
h2 {
  font-size:22px;
  font-weight:700;
  margin-bottom:20px;
  color:#111827;
  text-align:center;
}
.card {
  background:#fff;
  border-radius:16px;
  box-shadow:0 8px 20px rgba(0,0,0,0.06);
  padding:20px;
  margin-bottom:20px;
}
.card h5 {
  font-size:15px;
  font-weight:600;
  color:#374151;
  margin-bottom:10px;
}
.preview {
  width:100%;
  max-height:300px;
  object-fit:contain;
  border:1px dashed #cbd5e1;
  padding:8px;
  border-radius:12px;
  background:#000;
}
label {
  display:block;
  font-size:13px;
  color:#555;
  font-weight:500;
  margin-top:12px;
}
input[type="file"] {
  width:100%;
  padding:10px;
  border:1px solid #e5e7eb;
  border-radius:12px;
  font-size:14px;
  background:#f9fafb;
}
input[type="file"]:focus {
  outline:none;
  border-color:#8b5cf6;
  box-shadow:0 0 4px rgba(139,92,246,0.3);
  background:#fff;
}
button {
  padding:10px 14px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  transition:transform 0.2s ease, box-shadow 0.2s ease;
}
button.primary {
  background:#8b5cf6;
  color:#fff;
  width:100%;
  margin-top:16px;
}
button.primary:hover {
  background:#7c3aed;
  transform:translateY(-1px);
  box-shadow:0 4px 10px rgba(124,58,237,0.4);
}
.back-btn {
  display:inline-block;
  margin-bottom:15px;
  font-size:14px;
  font-weight:500;
  color:#374151;
  text-decoration:none;
  background:#e5e7eb;
  padding:6px 12px;
  border-radius:8px;
}
.back-btn:hover {
  background:#d1d5db;
}
</style>

<div class="container">
  <!-- Back button -->
  <a href="{% url 'certificates:ocr_upload' %}" class="back-btn">‚Üê Back to OCR Upload</a>

  <h2>üì± Mobile Capture</h2>

  <!-- Preview Section -->
  <div class="card text-center">
    {% if latest_file_url %}
      <h5>Latest Uploaded Image</h5>
      <img id="imgPreview" src="{{ latest_file_url }}?ts={{ timestamp }}" class="preview">
    {% else %}
      <p class="text-muted">No images uploaded yet.</p>
      <img id="imgPreview" class="preview" style="display:none;">
    {% endif %}
  </div>

  <!-- Capture / Upload Section -->
  <div class="card">
    <h5>Upload Options</h5>
    <label>üì∑ Take Photo</label>
    <input type="file" accept="image/*" capture="environment" id="cameraInput">

    <label>üñº Select from Gallery</label>
    <input type="file" accept="image/*" id="galleryInput">

    <button type="button" id="uploadBtn" class="primary">‚¨Ü Upload Image</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ---------------- CSRF token ----------------
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// ---------------- Elements ----------------
const cameraInput = document.getElementById('cameraInput');
const galleryInput = document.getElementById('galleryInput');
const uploadBtn = document.getElementById('uploadBtn');
const imgPreview = document.getElementById('imgPreview');

let selectedFile = null;

// Preview selected file
[cameraInput, galleryInput].forEach(input => {
  input.addEventListener('change', () => {
    if (input.files && input.files[0]) {
      selectedFile = input.files[0];
      imgPreview.src = URL.createObjectURL(selectedFile);
      imgPreview.style.display = 'block';
    }
  });
});

// Upload handler
uploadBtn.addEventListener('click', async () => {
  if (!selectedFile) {
    Swal.fire({ icon:'warning', title:'No Image Selected', text:'Please capture or select an image first.' });
    return;
  }

  const fd = new FormData();
  fd.append('image', selectedFile);

  Swal.fire({ title:'Uploading...', text:'Please wait while we upload your image.', allowOutsideClick:false, didOpen:()=>Swal.showLoading() });

  try {
    const res = await fetch("{% url 'certificates:mobile_upload' %}", {
      method: 'POST',
      body: fd,
      headers: { 'X-CSRFToken': csrftoken }
    });
    const data = await res.json();
    Swal.close();

    if (data.ok) {
      Swal.fire({ icon:'success', title:'Uploaded!', text:'Image uploaded successfully.' });
      imgPreview.src = data.url + '?ts=' + Date.now();
    } else {
      Swal.fire({ icon:'error', title:'Upload Failed', text:data.error || 'Something went wrong.' });
    }
  } catch (err) {
    Swal.close();
    Swal.fire({ icon:'error', title:'Network Error', text: err.message });
  }
});
</script>
{% endblock %}
